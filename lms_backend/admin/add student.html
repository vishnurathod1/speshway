<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Student - Admin</title>
  <link rel="stylesheet" href="/assets/css/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="admin">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2>Happy Learning</h2>
    <img src="/assets/images/logo.png" alt="Happy Learning Logo" class="sidebar-logo">
    <ul>
      <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="users.html" class="active"><i class="fas fa-users"></i> Users</a></li>
      <li><a href="courses.html"><i class="fas fa-book"></i> Course management</a></li>
      <li><a href="materials.html"><i class="fas fa-folder"></i> Materials</a></li>
      <li><a href="recorded classes.html"><i class="fas fa-video"></i> Recorded Classes</a></li>
      <li><a href="live classes.html"><i class="fas fa-video"></i> live Classes</a></li>
      <li><a href="assignments.html"><i class="fas fa-file-alt"></i> Assignments</a></li>
      <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
      <li><a href="notifications.html"><i class="fas fa-bell"></i> Notifications</a></li>
      <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      <li><a href="about.html"><i class="fas fa-info-circle"></i> About</a></li>
      <li><a href="contact.html"><i class="fas fa-envelope"></i> Contact</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <div class="logo">Student Management</div>
      <div class="user-menu">
        <img src="/assets/images/avatar.png" alt="Admin Avatar" />
        <span>Admin</span>
      </div>
    </header>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <button onclick="openAddModal('student')" class="btn-primary">âž• Add Student</button>
    </div>

    <!-- Students Table -->
    <div class="table-container">
      <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <h3>Students Management</h3>
        <div style="position: relative; display: flex; align-items: center;">
          <input
            type="text"
            id="studentSearch"
            placeholder="Search students..."
            style="padding: 8px 35px 8px 12px; border-radius: 8px; border: 1px solid #b63d3d; width: 250px;"
          />
          <button
            onclick="clearSearch('studentSearch', 'studentTableBody')"
            id="clearStudentSearch"
            style="position: absolute; right: 8px; background: none; border: none; color: #666; cursor: pointer; font-size: 16px; display: none;"
            title="Clear search"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <table id="studentTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Courses</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="studentTableBody">
          <!-- Students will be rendered here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Student data management
    class StudentManager {
      constructor() {
        this.students = this.getStudentsFromStorage();
        this.initializeEventListeners();
      }

      getStudentsFromStorage() {
        const students = localStorage.getItem('students');
        return students ? JSON.parse(students) : [];
      }

      saveStudentsToStorage() {
        localStorage.setItem('students', JSON.stringify(this.students));
      }

      generateStudentId() {
        return 'STU' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();
      }

      validateForm(formData) {
        const errors = {};

        // Name validation
        if (!formData.name || formData.name.trim().length < 2) {
          errors.name = 'Name must be at least 2 characters long';
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!formData.email || !emailRegex.test(formData.email)) {
          errors.email = 'Please enter a valid email address';
        }

        // Check for duplicate email
        if (formData.email && this.students.some(student => student.email.toLowerCase() === formData.email.toLowerCase())) {
          errors.email = 'A student with this email already exists';
        }

        // Phone validation (if provided)
        if (formData.phone && formData.phone.trim()) {
          const phoneRegex = /^[0-9+\-\s()]{10,15}$/;
          if (!phoneRegex.test(formData.phone)) {
            errors.phone = 'Please enter a valid phone number';
          }
        }

        // Status validation
        if (!formData.status) {
          errors.status = 'Please select a status';
        }

        return errors;
      }

      showMessage(message, type = 'info') {
        const messageContainer = document.getElementById('messageContainer');
        messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;

        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            messageContainer.innerHTML = '';
          }, 5000);
        }
      }

      clearErrors() {
        const errorElements = document.querySelectorAll('.field-error');
        errorElements.forEach(element => element.textContent = '');
      }

      showErrors(errors) {
        this.clearErrors();

        Object.keys(errors).forEach(field => {
          const errorElement = document.getElementById(`${field}Error`);
          if (errorElement) {
            errorElement.textContent = errors[field];
          }
        });
      }

      addStudent(studentData) {
        const student = {
          id: this.generateStudentId(),
          name: studentData.name.trim(),
          email: studentData.email.trim().toLowerCase(),
          phone: studentData.phone ? studentData.phone.trim() : '',
          courses: studentData.courses ? studentData.courses.trim() : '',
          status: studentData.status,
          joinDate: studentData.joinDate || new Date().toISOString().split('T')[0],
          createdAt: new Date().toISOString()
        };

        this.students.push(student);
        this.saveStudentsToStorage();
        return student;
      }

      resetForm() {
        document.getElementById('addStudentForm').reset();
        this.clearErrors();
        document.getElementById('messageContainer').innerHTML = '';
      }

      async handleFormSubmit(e) {
        e.preventDefault();

        const formData = {
          name: document.getElementById('studentName').value,
          email: document.getElementById('studentEmail').value,
          phone: document.getElementById('studentPhone').value,
          courses: document.getElementById('studentCourses').value,
          status: document.getElementById('studentStatus').value,
          joinDate: document.getElementById('studentJoinDate').value
        };

        // Clear previous errors
        this.clearErrors();

        // Validate form
        const errors = this.validateForm(formData);

        if (Object.keys(errors).length > 0) {
          this.showErrors(errors);
          this.showMessage('Please fix the errors below', 'error');
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.querySelector('.btn-text');
        const loadingSpinner = document.getElementById('loadingSpinner');

        btnText.textContent = 'Saving...';
        loadingSpinner.style.display = 'inline-block';
        submitBtn.disabled = true;

        try {
          // Simulate API call delay
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Add student
          const newStudent = this.addStudent(formData);

          // Show success message
          this.showMessage(`Student "${newStudent.name}" has been added successfully!`, 'success');

          // Reset form
          this.resetForm();

          // Update students page if it exists
          if (window.updateStudentsList) {
            window.updateStudentsList();
          }

        } catch (error) {
          this.showMessage('An error occurred while adding the student. Please try again.', 'error');
        } finally {
          // Reset button state
          btnText.textContent = 'Save';
          loadingSpinner.style.display = 'none';
          submitBtn.disabled = false;
        }
      }

      initializeEventListeners() {
        const form = document.getElementById('addStudentForm');
        const resetBtn = document.getElementById('resetBtn');

        form.addEventListener('submit', (e) => this.handleFormSubmit(e));
        resetBtn.addEventListener('click', () => this.resetForm());

        // Real-time validation
        const nameInput = document.getElementById('studentName');
        const emailInput = document.getElementById('studentEmail');
        const phoneInput = document.getElementById('studentPhone');

        nameInput.addEventListener('blur', () => {
          if (nameInput.value && nameInput.value.trim().length < 2) {
            document.getElementById('nameError').textContent = 'Name must be at least 2 characters long';
          }
        });

        emailInput.addEventListener('blur', () => {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (emailInput.value && !emailRegex.test(emailInput.value)) {
            document.getElementById('emailError').textContent = 'Please enter a valid email address';
          }
        });

        phoneInput.addEventListener('blur', () => {
          if (phoneInput.value && phoneInput.value.trim()) {
            const phoneRegex = /^[0-9+\-\s()]{10,15}$/;
            if (!phoneRegex.test(phoneInput.value)) {
              document.getElementById('phoneError').textContent = 'Please enter a valid phone number';
            }
          }
        });
      }
    }

    // Initialize student manager when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      window.studentManager = new StudentManager();

      // Add sample data for testing
      addSampleStudents();

      // Setup search functionality
      setupSearch();
    });

    // Function to setup search functionality
    function setupSearch() {
      const searchInput = document.getElementById('studentSearch');
      const clearButton = document.getElementById('clearStudentSearch');

      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();

          // Show/hide clear button based on input
          if (searchTerm.length > 0) {
            clearButton.style.display = 'block';
          } else {
            clearButton.style.display = 'none';
          }

          const students = JSON.parse(localStorage.getItem('students') || '[]');
          const filteredStudents = students.filter(student =>
            student.name.toLowerCase().includes(searchTerm) ||
            student.email.toLowerCase().includes(searchTerm) ||
            (student.courses && student.courses.toLowerCase().includes(searchTerm)) ||
            student.status.toLowerCase().includes(searchTerm)
          );
          renderFilteredStudents(filteredStudents);
        });
      }
    }

    // Function to clear search
    function clearSearch(searchInputId, tableBodyId) {
      const searchInput = document.getElementById(searchInputId);
      const clearButton = document.getElementById('clear' + searchInputId.charAt(0).toUpperCase() + searchInputId.slice(1));

      if (searchInput) {
        searchInput.value = '';
        clearButton.style.display = 'none';
        renderStudentTable(); // Show all students
      }
    }

    // Function to open modal
    function openAddModal(type) {
      const modal = document.getElementById('modal' + type.charAt(0).toUpperCase() + type.slice(1));
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    // Function to close modal
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Function to render filtered students
    function renderFilteredStudents(students) {
      const tableBody = document.getElementById('studentTableBody');

      if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.6);">No students found matching your search.</td></tr>';
        return;
      }

      tableBody.innerHTML = students.map(student => `
        <tr>
          <td>${student.name}</td>
          <td>${student.email}</td>
          <td>${student.courses || 'N/A'}</td>
          <td><span class="status ${student.status}">${student.status}</span></td>
          <td>
            <button onclick="editStudent('${student.id}')" class="btn-secondary" style="margin-right: 5px;">Edit</button>
            <button onclick="deleteStudent('${student.id}')" class="btn-danger">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Function to add sample student data
    function addSampleStudents() {
      const sampleStudents = [
        {
          id: 'STU001',
          name: 'John Smith',
          email: 'john.smith@email.com',
          phone: '+1-555-0123',
          courses: 'Mathematics, Physics',
          status: 'active',
          joinDate: '2024-01-15'
        },
        {
          id: 'STU002',
          name: 'Sarah Johnson',
          email: 'sarah.j@email.com',
          phone: '+1-555-0124',
          courses: 'Chemistry, Biology',
          status: 'active',
          joinDate: '2024-01-20'
        },
        {
          id: 'STU003',
          name: 'Mike Wilson',
          email: 'mike.w@email.com',
          phone: '+1-555-0125',
          courses: 'Computer Science',
          status: 'inactive',
          joinDate: '2024-01-10'
        }
      ];

      // Check if sample data already exists
      const existingStudents = JSON.parse(localStorage.getItem('students') || '[]');
      if (existingStudents.length === 0) {
        localStorage.setItem('students', JSON.stringify(sampleStudents));
        renderStudentTable();
      } else {
        renderStudentTable();
      }
    }

    // Function to render student table
    function renderStudentTable() {
      const students = JSON.parse(localStorage.getItem('students') || '[]');
      const tableBody = document.getElementById('studentTableBody');

      if (students.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: rgba(255,255,255,0.6);">No students found. Click "Add Student" to get started.</td></tr>';
        return;
      }

      tableBody.innerHTML = students.map(student => `
        <tr>
          <td>${student.name}</td>
          <td>${student.email}</td>
          <td>${student.courses || 'N/A'}</td>
          <td><span class="status ${student.status}">${student.status}</span></td>
          <td>
            <button onclick="editStudent('${student.id}')" class="btn-secondary" style="margin-right: 5px;">Edit</button>
            <button onclick="deleteStudent('${student.id}')" class="btn-danger">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // Function to edit student
    function editStudent(studentId) {
      const students = JSON.parse(localStorage.getItem('students') || '[]');
      const student = students.find(s => s.id === studentId);

      if (student) {
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editStudentName').value = student.name;
        document.getElementById('editStudentEmail').value = student.email;
        document.getElementById('editStudentPhone').value = student.phone || '';
        document.getElementById('editStudentCourses').value = student.courses || '';
        document.getElementById('editStudentStatus').value = student.status;
        document.getElementById('editStudentJoinDate').value = student.joinDate || '';

        openModal('editStudentModal');
      } else {
        alert('Student not found!');
      }
    }

    // Function to update student
    function updateStudent() {
      const studentId = document.getElementById('editStudentId').value;
      const name = document.getElementById('editStudentName').value.trim();
      const email = document.getElementById('editStudentEmail').value.trim();
      const phone = document.getElementById('editStudentPhone').value.trim();
      const courses = document.getElementById('editStudentCourses').value.trim();
      const status = document.getElementById('editStudentStatus').value;
      const joinDate = document.getElementById('editStudentJoinDate').value;

      // Basic validation
      if (!name || !email || !status) {
        alert('Please fill in all required fields.');
        return;
      }

      const students = JSON.parse(localStorage.getItem('students') || '[]');
      const studentIndex = students.findIndex(s => s.id === studentId);

      if (studentIndex !== -1) {
        students[studentIndex] = {
          ...students[studentIndex],
          name,
          email: email.toLowerCase(),
          phone,
          courses,
          status,
          joinDate
        };

        localStorage.setItem('students', JSON.stringify(students));
        renderStudentTable();
        closeModal('editStudentModal');
        alert('Student updated successfully!');
      } else {
        alert('Student not found!');
      }
    }

    // Function to delete student
    function deleteStudent(studentId) {
      if (confirm('Are you sure you want to delete this student?')) {
        const students = JSON.parse(localStorage.getItem('students') || '[]');
        const updatedStudents = students.filter(student => student.id !== studentId);
        localStorage.setItem('students', JSON.stringify(updatedStudents));
        renderStudentTable();
        alert('Student deleted successfully!');
      }
    }
  </script>

  <!-- Student Modal -->
  <div class="modal" id="modalStudent">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('modalStudent')">&times;</span>
      <h3 id="modalStudentTitle">Add Student</h3>

      <!-- Message Display Area -->
      <div id="messageContainer"></div>

      <form id="addStudentForm">
        <div class="form-row">
          <label for="studentName">Name *</label>
          <input type="text" id="studentName" name="studentName" placeholder="Enter student name" required minlength="2" maxlength="50" />
          <div class="field-error" id="nameError"></div>
        </div>

        <div class="form-row">
          <label for="studentEmail">Email *</label>
          <input type="email" id="studentEmail" name="studentEmail" placeholder="Enter student email" required />
          <div class="field-error" id="emailError"></div>
        </div>

        <div class="form-row">
          <label for="studentPhone">Phone Number</label>
          <input type="tel" id="studentPhone" name="studentPhone" placeholder="Enter phone number (optional)" pattern="[0-9+\-\s()]{10,15}" />
          <div class="field-error" id="phoneError"></div>
        </div>

        <div class="form-row">
          <label for="studentCourses">Courses Enrolled</label>
          <input type="text" id="studentCourses" name="studentCourses" placeholder="Enter courses (comma separated)" />
          <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Example: Mathematics, Physics, Chemistry</small>
        </div>

        <div class="form-row">
          <label for="studentStatus">Status *</label>
          <select id="studentStatus" name="studentStatus" required>
            <option value="">Select status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <div class="field-error" id="statusError"></div>
        </div>

        <div class="form-row">
          <label for="studentJoinDate">Join Date</label>
          <input type="date" id="studentJoinDate" name="studentJoinDate" />
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" id="submitBtn">
            <span class="btn-text">Save</span>
            <span class="loading" id="loadingSpinner" style="display: none;"></span>
          </button>
          <button type="reset" class="btn-secondary" id="resetBtn">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editStudentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('editStudentModal')">&times;</span>
      <h3>Edit Student</h3>
      <input type="hidden" id="editStudentId" />
      <div class="form-row">
        <label for="editStudentName">Name *</label>
        <input type="text" id="editStudentName" name="editStudentName" placeholder="Enter student name" required minlength="2" maxlength="50" />
        <div class="field-error" id="editNameError"></div>
      </div>
      <div class="form-row">
        <label for="editStudentEmail">Email *</label>
        <input type="email" id="editStudentEmail" name="editStudentEmail" placeholder="Enter student email" required />
        <div class="field-error" id="editEmailError"></div>
      </div>
      <div class="form-row">
        <label for="editStudentPhone">Phone Number</label>
        <input type="tel" id="editStudentPhone" name="editStudentPhone" placeholder="Enter phone number (optional)" pattern="[0-9+\-\s()]{10,15}" />
        <div class="field-error" id="editPhoneError"></div>
      </div>
      <div class="form-row">
        <label for="editStudentCourses">Courses Enrolled</label>
        <input type="text" id="editStudentCourses" name="editStudentCourses" placeholder="Enter courses (comma separated)" />
        <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Example: Mathematics, Physics, Chemistry</small>
      </div>
      <div class="form-row">
        <label for="editStudentStatus">Status *</label>
        <select id="editStudentStatus" name="editStudentStatus" required>
          <option value="">Select status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <div class="field-error" id="editStatusError"></div>
      </div>
      <div class="form-row">
        <label for="editStudentJoinDate">Join Date</label>
        <input type="date" id="editStudentJoinDate" name="editStudentJoinDate" />
      </div>
      <div class="form-actions">
        <button type="button" class="btn-primary" id="updateBtn" onclick="updateStudent()">
          <span class="btn-text">Update</span>
          <span class="loading" id="updateLoadingSpinner" style="display: none;"></span>
        </button>
        <button type="button" class="btn-secondary" onclick="closeModal('editStudentModal')">Cancel</button>
      </div>
    </div>
  </div>
</body>
</html>
